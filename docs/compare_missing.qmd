---
title: "Missing zeros in GCRMN data"
author: "Murray Logan"
date: today
date-format: "DD/MM/YYYY"
format:
  html:
    ## Format
    theme: [default, resources/style.scss]
    css: resources/style.css
    html-math-method: mathjax
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    page-layout: full
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-width: 4
    fig-height: 4
    out-width: 500px
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    code-block-border-left: "#ccc"
    code-copy: true
    highlight-style: atom-one
    ## Execution
    execute:
      echo: true
      #cache: true
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
## execute:
##   cache: true
jupyter: python3
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: resources/references.bib
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
    cache.lazy = FALSE,
    tidy = "styler"
)
## allow indented chunks
assignInNamespace(".sep.label",
  "^\\ *(#|--)+\\s*(@knitr|----+)(.*?)-*\\s*$",
    ns = "knitr"
)
knitr::read_chunk("../R/process_spatial.R")
knitr::read_chunk("../R/process_benthic_data.R")
knitr::read_chunk("../R/fit_models.R")
knitr::read_chunk("../R/aggregate_models.R")
knitr::read_chunk("../R/helper_functions.R")
## knitr::read_chunk("../python/incomplete_spatial.py")
## remove the indentation from all python chunks that start
## with indentation
codes <- knitr::knit_code$get()
process_chunks <- function(codes) {
  nms <- names(codes)
  wch <- which(startsWith(names(codes), "python"))
  codes1 <- lapply(1:length(codes), function(i) {
    if (i %in% wch) {
      x <- gsub("^ {4}", "", codes[[i]])
    } else {
      x <- codes[[i]]
    }
    x
  })
  names(codes1) <- nms
  codes1
}
knitr::knit_code$set(
  process_chunks(codes)
)

options(tinytex.engine =  'xelatex')
```

```{css, echo=FALSE}
figcaption {
  text-align: left !important;
}
```


## Purpose

The intention of this page is to compare the estimates of a selection
of ecoregions, subregions and regions with and without the application
of zero filling.  The original supplied data were mostly positive only
records.  That is, a taxa was only recorded when it was present.  In
many locations, it is very rare for a dataset not to register any
values in a major benthic categories (Hard coral, Algae and
Macroalgae) for each sampling unit (e.g. transect) when a survey is
conducted.  However, in other locations if a particular benthic
category is relatively rare or else in low abundance (e.g. Macroalgae
in some places), if only positive observations are recorded the
compiled data may appear to have only sparse data.  This will result
in a upward bias in the cover estimates (and uncertainty) for this
benthic category.

In order to "fill in" these "missing zeros", we can add zero
percentage cover records at the replicate level (typically transects)
for each absent benthic category within any datasets and years where
it is determined that the transect was surveyed (based on the presence
of other benthic categories).  Implicit in this operation is the
assumption that if a transect was surveyed, observers had the chance
to record each taxa and only did not if it was not present.

```{r}
#| label: libraries 
#| eval: true
#| echo: false
#| warning: false
#| message: false
#| cache: false
library(tidyverse)
```

## Ecoregions

```{r}
#| label: read aggregate ecoregion plots
#| eval: true
#| echo: false
#| warning: false
#| message: false
#| cache: false
benthic_posteriors_ecoregions <- targets::tar_read("aggregate_ecoregion_plots_", store = "../R/_targets")
```

```{r}
#| label: aggregate ecoregion plots
#| eval: true
#| echo: false
#| output: asis
#| warning: false
#| message: false
#| cache: false
cat("::: {.panel-tabset}\n")

for (eco in c("Panama Bight", "Central and Southern Great Barrier Reef")) {
  cat(paste0("### ", eco, "\n"))
      dat_eco <- benthic_posteriors_ecoregions |>
        dplyr::filter(ecoregion == eco)
      cat("::: {.panel-tabset}\n")
      xcats <- levels(forcats::fct_relevel(unique(dat_eco$category), c('Hard coral', 'Macroalgae'))) 
      for (catg in xcats) {
        cat(paste0("##### ", catg, "\n"))
        dat_cat <- dat_eco |>
          dplyr::filter(category == catg)

        fig <- dat_cat$plot[[1]]
        fig1a_V2 <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
        fig2a_V2 <- str_replace(fig, "pdp", "pdp_a_V2") 
        fig10a_V2 <- str_replace(fig, "pdp", "pdp_a_V2") |>
                     str_replace("output/figures/", "output_old/figures/")
        # cat("The left column of figures displays the Bayesian Hierachical smoothed estimates and the right column displays the unsmoothed estimates.\n\n")
        # cat(paste0(
        #   "![](", fig10a_V2, "){width=400px}",
        #   "![](", fig2a_V2, "){width=400px}",
        #   "![](", fig1a_V2, "){width=400px}\n\n"
        # ))

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig10a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line; xgboost: blue ribbon with blue line) in ", catg ,
       " for the ", eco, " GCRMN ecoregion without filling in missing zeros.  
       The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.\n"))
       cat("::::\n\n")
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig2a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line; xgboost: blue ribbon with blue line) in ", catg ,
       " for the ", eco, " GCRMN ecoregion with missing zeros filled in.  
       The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.  Note, the xgboost trend is included 
       for scaling purposes only as it was not re-run with missing values filled in.\n"))
       cat("::::\n\n")
       cat(":::\n\n")
      
       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig1a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line) in ", catg ,
       " for the ", eco, " GCRMN ecoregion with missing zeros filled in.  
       The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

      }
      cat(":::\n")
}
cat(":::\n")
```
   

## Subregions

```{r}
#| label: read aggregate subregion plots
#| eval: true
#| echo: false
#| warning: false
#| message: false
#| cache: false
benthic_posteriors_subregions <- targets::tar_read("aggregate_subregion_plots_", store = "../R/_targets")
wts <- targets::tar_read("process_spatial_weights_", store = "../R/_targets") |>
  mutate(GCRMN_region = str_replace(GCRMN_region, "East Asia", "EAS"),
    GCRMN_subregion = str_replace(GCRMN_subregion, "East Asia", "EAS")
  )
wts_subregions <- targets::tar_read("wts_subregions_", store = "../R/_targets") 
summary_subregion <- targets::tar_read("summary_subregion_", store = "../R/_targets")
summary_subregion_V2 <- targets::tar_read("summary_subregion_V2_", store = "../R/_targets")
```

```{r}
#| label: aggregate subregion plots
#| eval: true
#| echo: false
#| output: asis
#| warning: false
#| message: false
#| cache: false
cat("::: {.panel-tabset}\n")
  for (subreg in c("ETP 3", "Australia 5")) {
    cat(paste0("### ", subreg, "\n"))
    dat_subreg <- summary_subregion |>
      filter(subregion == subreg)
      cat("::: {.panel-tabset}\n")
      xcats <- levels(forcats::fct_relevel(unique(dat_subreg$category), c('Hard coral', 'Macroalgae'))) 
      for (catg in xcats) {
        cat(paste0("##### ", catg, "\n"))
        dat_cat <- dat_subreg |>
          filter(category == catg)
        fig <- dat_cat$plot[[1]]
        fig1a_V2 <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
        fig2a_V2 <- str_replace(fig, "pdp", "pdp_a_V2")
        fig10a_V2 <- str_replace(fig, "pdp", "pdp_a_V2") |>
                     str_replace("output/figures/", "output_old/figures/")
        cat("The left column of figures displays the Bayesian Hierachical smoothed estimates and the right column displays the unsmoothed estimates.\n\n")
        # cat(paste0(
        #   "![](", fig10a_V2, "){width=400px}",
        #   "![](", fig1a_V2, "){width=400px}\n\n"
        # ))

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig10a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line; xgboost: blue ribbon with blue line) in ", catg ,
       " for the ", subreg, " GCRMN subregion without filling in missing zeros.  
       The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.\n"))
       cat("::::\n\n")
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig2a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line; xgboost: blue ribbon with blue line) in ", catg ,
       " for the ", subreg, " GCRMN subregion with missing zeros filled in.  
       The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.  Note, the xgboost trend is included 
       for scaling purposes only as it was not re-run with missing values filled in.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig1a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line) in ", catg ,
       " for the ", subreg, " GCRMN subregion with missing zeros filled in.  The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.\n"))
       cat("::::\n\n")
       cat(":::\n\n")
      }
      cat(":::\n")
  }
cat(":::\n")
```

## Regions


```{r}
#| label: read aggregate region plots
#| eval: true
#| echo: false
#| warning: false
#| message: false
#| cache: false
## benthic_posteriors_regions <- targets::tar_read("aggregate_region_plots_", store = "../R/_targets")
## benthic_posteriors_regions_V2 <- targets::tar_read("aggregate_region_plots_V2_", store = "../R/_targets")
summary_region <- targets::tar_read("summary_region_", store = "../R/_targets")
summary_region_V2 <- targets::tar_read("summary_region_V2_", store = "../R/_targets")
wts_regions <- targets::tar_read("wts_regions_", store = "../R/_targets") 
```

```{r}
#| label: aggregate region plots
#| eval: true
#| echo: false
#| output: asis
#| warning: false
#| message: false
#| cache: false
cat("::: {.panel-tabset}\n")
for (reg in sort(unique(summary_region$region))) {
  dat_reg <- summary_region |>
    filter(region == reg)
  cat(paste0("#### ", reg, "\n"))
  cat("::: {.panel-tabset}\n")
  xcats <- levels(forcats::fct_relevel(unique(dat_reg$category), c('Hard coral', 'Macroalgae'))) 
  for (catg in xcats) {
  ## for (catg in sort(unique(dat_reg$category))) {
    cat(paste0("####### ", catg, "\n"))
    dat_cat <- dat_reg |>
      filter(category == catg)
    fig <- dat_cat$plot[[1]]
    fig1a_V2 <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
    fig2a_V2 <- str_replace(fig, "pdp", "pdp_a_V2")
    fig2a <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
        fig10a_V2 <- str_replace(fig, "pdp", "pdp_a_V2") |>
                     str_replace("output/figures/", "output_old/figures/")
    # cat(paste0(
    #   "![](", fig10a_V2, "){width=400px}",
    #   "![](", fig2a, "){width=400px}\n\n"
    #   ))

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig10a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line; xgboost: blue ribbon with blue line) in ", catg ,
       " for the ", subreg, " GCRMN subregion without filling in missing zeros.  
       The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.\n"))
       cat("::::\n\n")
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig2a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line; xgboost: blue ribbon with blue line) in ", catg ,
       " for the ", reg, " GCRMN region with missing zeros filled in.  
       The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.  Note, the xgboost trend is included 
       for scaling purposes only as it was not re-run with missing values filled in.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig1a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical: orange
       ribbon with white line) in ", catg ,
       " for the ", reg, " GCRMN region with missing zeros filled in.  The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

  }
  cat(":::\n")
}
cat(":::\n")
```
 