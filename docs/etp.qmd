---
title: "Comparing models - ETP"
author: "Murray Logan"
date: today
date-format: "DD/MM/YYYY"
format:
  html:
    ## Format
    theme: [default, resources/style.scss]
    css: resources/style.css
    html-math-method: mathjax
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    page-layout: full
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-width: 4
    fig-height: 4
    out-width: 500px
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    code-block-border-left: "#ccc"
    code-copy: true
    highlight-style: atom-one
    ## Execution
    execute:
      echo: true
      #cache: true
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
## execute:
##   cache: true
jupyter: python3
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
monofont: DejaVu Sans Mono
classoption: a4paper
bibliography: resources/references.bib
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
    cache.lazy = FALSE,
    tidy = "styler"
)
## allow indented chunks
assignInNamespace(".sep.label",
  "^\\ *(#|--)+\\s*(@knitr|----+)(.*?)-*\\s*$",
    ns = "knitr"
)
knitr::read_chunk("../R/process_spatial.R")
knitr::read_chunk("../R/process_benthic_data.R")
knitr::read_chunk("../R/fit_models.R")
knitr::read_chunk("../R/aggregate_models.R")
knitr::read_chunk("../R/helper_functions.R")
## knitr::read_chunk("../python/incomplete_spatial.py")
## remove the indentation from all python chunks that start
## with indentation
codes <- knitr::knit_code$get()
process_chunks <- function(codes) {
  nms <- names(codes)
  wch <- which(startsWith(names(codes), "python"))
  codes1 <- lapply(1:length(codes), function(i) {
    if (i %in% wch) {
      x <- gsub("^ {4}", "", codes[[i]])
    } else {
      x <- codes[[i]]
    }
    x
  })
  names(codes1) <- nms
  codes1
}
knitr::knit_code$set(
  process_chunks(codes)
)

options(tinytex.engine =  'xelatex')
```

```{css, echo=FALSE}
figcaption {
  text-align: left !important;
}
```

```{r}
#| label: packages
#| echo: false
#| eval: true
#| cache: false
#| warning: false
#| message: false
#| output: false
library(tidyverse)
library(kableExtra)
```


## Guide

In each of the following sections:

- the dark blue line represents the mean of the cover estimates
  (bootstrapped xgboost model)
- the blue band represents the 95% interval of cover estimates
  (bootstrapped xgboost model)
- the white line represents the posterior median of cover estimates
  (Bayesian Heirarchical model)
- the darkest orange band represents the 80% credibility interval of
  cover estimates (Bayesian Heirarchical model)
- the orange band represents the 95% credibility interval of the
  cover estimates (Bayesian Heirarchical model)
- the light orange band represents the 95% credibility interval of
  cover estimates for years in which there were no observed data in
  the presented spatial scale (e.g. Ecoregion, Subregion or Region)
  (Bayesian Heirarchical model).
- in the case of Subregions and Regions, the light orange band only
  appears for spans of years for which there were no observations
  across all the consistuent spatial units.

Within the Ecoregion level, each Ecoregion tab, comprises the following
tabs:

::: {.panel-tabset}

#### Modelled trends

Within Ecoregions, temporal (Modelled) trends are represented by four figures:

- left hand figure: Bayesian Hierachical (orange) and xgboost (blue)
  estimates for the temporal domain of the observed data for that
  Ecoregion overlayed onto observed data

- right hand figure: Bayesian Hierachical (orange) and xgboost (blue)
  estimates for the temporal domain of the observed data for that
  Ecoregion

#### Simple mean/median trends

To assist in the evaluation of the models, we have also calculated two
forms of simple summary statistics:

- Simple means/medians represent the means and medians of all
  available observations in the ecoregion per year

- Hierarchical means and medians of the available observed data are
calculated as averages of averages (etc) starting at the
level of Dataset/Replicates/Years -> Dataset/Site/Years -> Dataset/Grid/Years -> Dataset/Years -> Years.

These two alternatives can yield very different estimates.  This
hierachical averaging takes partial account for differences in
Datasets and spatial units.

That said, neither method are as good as statistical models for
representing population trends as they implicitly makes very specific
and arguably unjustified assumptions about the distribution of data
(gaussian) and fail to capture the repeated measurement nature of much
monitoring data.  Also note, that if the locations and methods change
between years, then so too can the sample bias and this results in
inconsistent estimates between years.

Also note, that unlike the models, the simple and hierarchical
means/medians are not weighted by reef area and are instead going to
be heavily driven by sample sizes.

#### Data conditional on Dataset ID

In this section we have produced simple exploratory plots conditioned
on DatasetID so as to get a feel for the temporal distribution of each
dataset.  The smooth trends are simple splines.

#### Data conditional on grid id

In this section we have produced simple exploratory plots conditioned
on grid_id (broad location) so as to get a feel for the temporal
distribution of each location.  The smooth trends are simple splines.

:::




```{r}
#| label: read aggregate ecoregion plots
#| eval: true
#| echo: false
#| warning: false
#| message: false
#| cache: false
benthic_posteriors_ecoregions <- targets::tar_read("aggregate_ecoregion_plots_", store = "../R/_targets")
```

```{r}
#| label: read aggregate subregion plots
#| eval: true
#| echo: false
#| warning: false
#| message: false
#| cache: false
benthic_posteriors_subregions <- targets::tar_read("aggregate_subregion_plots_", store = "../R/_targets")
wts <- targets::tar_read("process_spatial_weights_", store = "../R/_targets") |>
  mutate(GCRMN_region = str_replace(GCRMN_region, "East Asia", "EAS"),
    GCRMN_subregion = str_replace(GCRMN_subregion, "East Asia", "EAS")
  )
wts_subregions <- targets::tar_read("wts_subregions_", store = "../R/_targets") 
wts_regions <- targets::tar_read("wts_regions_", store = "../R/_targets") 
spatial_lookup <- targets::tar_read("spatial_lookup_", store = "../R/_targets") 
summary_subregion <- targets::tar_read("summary_subregion_", store = "../R/_targets")
summary_subregion_V2 <- targets::tar_read("summary_subregion_V2_", store = "../R/_targets")
contrasts_subregions <- targets::tar_read("contrasts_subregions_", store = "../R/_targets")
```
 
```{r}
#| label: read aggregate region plots
#| eval: true
#| echo: false
#| warning: false
#| message: false
#| cache: false
benthic_posteriors_regions <- targets::tar_read("aggregate_region_plots_", store = "../R/_targets")
summary_region <- targets::tar_read("summary_region_", store = "../R/_targets")
summary_region_V2 <- targets::tar_read("summary_region_V2_", store = "../R/_targets")
contrasts_regions <- targets::tar_read("contrasts_regions_", store = "../R/_targets")
region_tbls <- targets::tar_read("region_tbls_", store = "../R/_targets")
```
 
```{r}
#| label: aggregate ecoregion plots
#| eval: true
#| echo: false
#| output: asis
#| warning: false
#| message: false
#| cache: false
## cat("::: {.panel-tabset}\n")
reg <- "ETP"
dat_reg <- benthic_posteriors_ecoregions |>
## dat_reg <- summary_region |>
 dplyr::filter(region == reg)
##cat("::: {.panel-tabset}\n")
cats <- sort(unique(dat_reg$category))
## cats <- cats |> str_subset("Hard coral|Macroalgae|Turf algae")
## Make the order Hard coral, Macroalgae and then the rest (but drop Other fauna)
cats <- setdiff(cats, "Other fauna")
cats <- c(intersect(c("Hard coral", "Macroalgae"), cats),
          setdiff(cats, c("Hard coral", "Macroalgae")))
 
for (catg in cats) {
  cat(paste0("## ", catg, "\n"))
  ## Ecoregion level =====================================================================
  cat(paste0("### Ecoregion level\n"))
  dat_cat <- dat_reg |>
    dplyr::filter(category == catg)
  cat("::: {.panel-tabset}\n")
  for (subreg in sort(unique(dat_cat$subregion))) {
    dat_subreg <- dat_cat |>
      dplyr::filter(subregion == subreg)
    subreg_name <- dat_subreg |> pull(subregion_name) |> unique()
    cat(paste0("###### ", subreg_name, "\n"))
    cat("::: {.panel-tabset}\n")
    for (eco in sort(unique(dat_subreg$ecoregion))) {
      cat(paste0("###### ", eco, "\n"))
      dat_eco <- dat_subreg|>
        dplyr::filter(ecoregion == eco)
      cat("::: {.panel-tabset}\n")
             
      cat(paste0("######## Modelled trends\n"))
      fig <- dat_eco$plot[[1]]
      fig2 <- str_replace(fig, "pdp", "pdpraw")
      fig1a <- str_replace(fig, "pdp", "pdp_a")
      fig1a_V2 <- str_replace(fig, "pdp", "pdp_a_V2")
      fig3 <- str_replace(fig, "pdp", "pdprawxgboost")
      fig3a <- str_replace(fig, "pdp", "pdprawxgboost_a")
      fig3a_V2 <- str_replace(fig, "pdp", "pdprawxgboost_a_V2")
      fig4a_V2 <- str_replace(fig, "pdp", "pdpraw_a_V2")
      fig5a_V2 <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
      ## cat(paste0(#"![](", fig2, "){width=300px}",
      ##            ## "![](", fig, "){width=300px}",
      ##            ## "![](", fig3, "){width=300px}\n",
      ##            ## "![](", fig1a, "){width=300px}",
      ##            ## "![](", fig3a, "){width=300px}\n\n"
      ##            ## "![](", fig1a_V2, "){width=400px}",
      ##            ## "![](", fig3a_V2, "){width=400px}\n\n"
      ##            "![](", fig4a_V2, "){width=400px}",
      ##            "![](", fig5a_V2, "){width=400px}\n\n"
      ##            ))
     
       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig4a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (orange
       ribbon with white line) in ", catg , " with overlayed observed data
       (dots) for the ", eco, " GCRMN ecoregion.  The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data. Thin grey lines join sampling units that 
       are repeatedly measured over time.\n"))
       cat("::::\n\n")
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig5a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (orange
       ribbon with white line) in ", catg , " for the ", eco, " GCRMN 
       ecoregion.  The orange bands represent 80% and 95% (darker) 
       credibility intervals.  Grey ribbon represents years for which 
       there are no observed data.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

      cat(paste0("######## Simple mean/median trends\n"))
        fig5a <- str_replace(fig, "pdp", "raw_pdp_simple") |>
                 str_replace("figures/ecoregion/ecoregion_", "figures/raw/")
        fig6 <- str_replace(fig, "pdp", "pdprawxgboost_a_simple")
        ## fig6a_V2 <- str_replace(fig, "pdp", "pdprawxgboost_a_simple_V2")
        fig6a_V2 <- str_replace(fig, "pdp", "pdpraw_bayes_a_simple_V2")
        fig7 <- str_replace(fig, "pdp", "pdp_a_simple")
        fig7a_V2 <- str_replace(fig, "pdp", "pdp_bayes_a_simple_V2")
        cat("In each of the following figures, the salmon colored line/points represent the simple hierarchical **means**, the teal coloured line/dots represent the hierarchical **medians**.  The left column of figures displays the Bayesian Hierachical smoothed estimates and the right column displays the unsmoothed estimates.\n\n")
        ## cat(paste0(
        ##   ## "![](", fig7, "){width=400px}",
        ##   "![](", fig7a, "){width=400px}\n",
        ##   ## "![](", fig6, "){width=400px}",
        ##   "![](", fig6a, "){width=400px}\n",
        ##   "![](", fig5a, "){width=400px}\n\n"))

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')

       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig7a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical model: orange
       ribbon with white line) and simple and hierarhical summaries (colored dots and lines)
       in ", catg , " for the ", eco, " GCRMN 
       ecoregion.  The orange bands represent 80% and 95% (darker) 
       credibility intervals.  Grey ribbon represents years for which 
       there are no observed data.  Thin grey lines join sampling units that 
       are repeatedly measured over time.\n"))
       cat("::::\n\n")

       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig6a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (Bayesian Hierarchical model: orange
       ribbon with white line), simple and hierarhical summaries (colored dots and lines) 
       and observed data (grey/black dots) in ", catg , " for the ", eco, " GCRMN 
       ecoregion.  The orange bands represent 80% and 95% (darker) 
       credibility intervals.  Grey ribbon represents years for which 
       there are no observed data. Thin grey lines join sampling units that 
       are repeatedly measured over time.\n"))
       cat("::::\n\n")

       cat(":::\n\n")


       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig5a,"){width=400px}\n\n"))
       cat(paste0("Simple and hierarchical summaries (mean and median) and observed 
       data (dots) in ", catg , " for the ", eco, " GCRMN 
       ecoregion.  Thin grey lines join sampling units that 
       are repeatedly measured over time.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

      cat(paste0("######## Data conditional on dataset ID\n"))
      fig6a <- str_replace(fig, "pdp", "raw_pdp_datasetID") |>
               str_replace("figures/ecoregion/ecoregion_", "figures/raw/")
      cat("The salmon colored line/points represent the simple hierarchical **means**, the teal coloured line/dots represent the hierarchical **medians**\n\n")
      ## cat(paste0(
      ##   "![](", fig1a_V2, "){width=400px}\n",
      ##   "![](", fig6a, "){width=700px}\n\n"))

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig4a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (orange
       ribbon with white line) in ", catg , " with overlayed observed data
       (dots) for the ", eco, " GCRMN ecoregion.  The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data. Thin grey lines join sampling units that 
       are repeatedly measured over time.\n"))
       cat("::::\n\n")

       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig6a,"){width=400px}\n\n"))
       cat(paste0("Observed data (dots) with simple gam smoothers (red ribbon) 
       conditional on datasetID (facets) in ", catg , " for the ", eco, " 
       GCRMN ecoregion.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

      
      cat(paste0("######## Data conditional on grid ID\n"))
      fig7a <- str_replace(fig, "pdp", "raw_pdp_grid_id") |>
               str_replace("figures/ecoregion/ecoregion_", "figures/raw/")
      cat("The salmon colored line/points represent the simple hierarchical **means**, the teal coloured line/dots represent the hierarchical **medians**\n\n")
      ## cat(paste0(
      ##   "![](", fig1a_V2, "){width=400px}\n",
      ##   "![](", fig7a, "){width=700px}\n\n"
      ##   ))

       cat('::: {layout="[ 0.49, -0.01, 0.49 ]"}\n\n')
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig4a_V2,"){width=400px}\n\n"))
       cat(paste0("Modelled temporal trend (orange
       ribbon with white line) in ", catg , " with overlayed observed data
       (dots) for the ", eco, " GCRMN ecoregion.  The orange bands represent
       80% and 95% (darker) credibility intervals.  Grey ribbon represents 
       years for which there are no observed data. Thin grey lines join sampling units that 
       are repeatedly measured over time.\n"))
       cat("::::\n\n")
       cat(":::: {.figure #fig-x}\n")
       cat(paste0("![](", fig7a,"){width=400px}\n\n"))
       cat(paste0("Observed data (dots) with simple gam smoothers (red ribbon) 
       conditional on grid ID (facets) in ", catg , " for the ", eco, " 
       GCRMN ecoregion.\n"))
       cat("::::\n\n")
       cat(":::\n\n")

      cat(":::\n")
    }
    cat(":::\n")
  }
  cat(":::\n")

  ## Subregion level =====================================================================
  cat(paste0("### Subregion level\n"))
  cat("::: {.panel-tabset}\n")
  for (subreg in sort(unique(dat_cat$subregion))) {
    dat_subreg <- summary_subregion |>
      dplyr::filter(category == catg, subregion == subreg)
    subreg_name <- dat_subreg |> pull(subregion_name) |> unique()
    cat(paste0("###### ", subreg_name, "\n"))
    fig <- dat_subreg$plot[[1]]
    fig1a <- str_replace(fig, "pdp", "pdp_a")
    fig1a_V2 <- str_replace(fig, "pdp", "pdp_a_V2")
    fig2 <- str_replace(fig, "pdp", "pdpraw")
    fig3 <- str_replace(fig, "pdp", "pdprawxgboost")
    fig3a <- str_replace(fig, "pdp", "pdprawxgboost_a")
    fig3a_V2 <- str_replace(fig, "pdp", "pdp_a_V2")
    fig4a_V2 <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
    ## cat(paste0(#"![](", fig2, "){width=300px}",
    ##   #"![](", fig, "){width=300px}",
    ##   ## "![](", fig3, "){width=400px}",
    ##   "![](", fig3a_V2, "){width=400px}\n\n"
    ## ))


    cat("::: {.figure #fig-x}\n")
    cat(paste0("![](", fig4a_V2,"){width=400px}\n\n"))
    cat(paste0("Modelled temporal trend (orange
    ribbon with white line) in ", catg , " with overlayed observed data
    (dots) for the ", subreg, " GCRMN subregion.  The orange bands represent
    80% and 95% (darker) credibility intervals.  Grey ribbon represents 
    years for which there are no observed data.\n"))
    cat(":::\n\n")

    cat('::: {.callout-note collapse="true"}\n#### View weights\n')
    cat("::: {#tbl-wts}\n")
    ## wts |>
    ##   mutate(GCRMN_subregion = str_replace(GCRMN_subregion, "\\.", " ")) |>
    ##   filter(GCRMN_region == reg,
    ##          GCRMN_subregion == subreg) |>
    ##   dplyr::select(Region = GCRMN_region,
    ##                 Subregion = GCRMN_subregion,
    ##                 Ecoregion = ECOREGION,
    ##                 Area = area,
    ##                 Weight = wt) |>
    wts_subregions |>
      left_join(spatial_lookup |>
        dplyr::select(subregion, subregion_name) |>
        distinct(),
        by="subregion") |>
      filter(region==reg, subregion==subreg) |>
      dplyr::select(Region=region,
        Subregion=subregion,
        Subregion_name=subregion_name,
        Ecoregion=ECOREGION,
        Area=area,
        Weight = wt
      ) |>
      # knitr::kable(caption = "Ecoregion (MEOW) reef area and weights applied in the aggregation up to Subregion") |>
      knitr::kable() |>
      print()
    cat(paste0("Subregion reef area and weights applied in the aggregation up to Subregion.\n"))
    cat(":::\n")
    cat(":::\n")

    cat("::: {.callout-note collapse=true}\n")
    cat("#### Show data behind figure\n")
    cat("::: {#tbl-data}\n")
    summary_subregion_V2 |>
      filter(category == catg, region == reg, subregion == subreg) |>
      _[["cellmeans_trim"]][[1]] |>
      dplyr::select(-variable) |>
      dplyr::mutate(across(c(median, lower, upper, lower_80, upper_80), \(x) round(x * 100, 2))) |>
      # knitr::kable(caption = paste0("Estimated annual ", catg, " cover (%) at the subregion scale.")) |>
      knitr::kable() |>
      print()
    cat(paste0("Estimated annual ", catg, " cover (%) at the subregion scale.\n")) 
    cat(":::\n")
    cat(":::\n")

    cat("::: {.callout-note collapse=true}\n")
    cat("#### Show contrasts\n")
    cat("::: {#tbl-contr}\n")
    contrasts_subregions |>
      filter(category == catg, region == reg, subregion == subreg) |>
      _[["contrast_sum"]][[1]] |>
      # knitr::kable(caption = paste0("Contrasts between pairs of years for ", catg, " cover (%) at the subregion scale.
      # For each contrast, results are expressed as absolute change (`abs`) and percentage change (`frac`).   Negative values indicate declines between the pairs of years.  `Pl` and `Pg`
      # represent the probability of decline and increase respectively.")) |>
      knitr::kable() |> 
      print()
    cat(paste0("- ", 
      contrasts_subregions |>
        filter(category == catg, region == reg, subregion == subreg) |>
        _[["narrative"]][[1]]$interpretation, sep="\n\n")
      )
      
    cat(paste0("Contrasts between pairs of years for ", catg, " cover (%) at the subregion scale.
    For each contrast, results are expressed as absolute change (`abs`) and 
    percentage change (`frac`). Estimated average cover at the left side of the contrast 
    (`start`) and the right side of the contrast (`end`) are also presented.  
    Negative values indicate declines between the pairs of years. `Pl` and `Pg`
    represent the probability of decline and increase respectively.\n"))
    cat(":::\n")
    cat(":::\n")
  }
  cat(":::\n")

  ## Region level =====================================================================
  cat(paste0("### Region level\n"))
  data_reg <- benthic_posteriors_regions |>
    dplyr::filter(category == catg, region == reg)
  fig <- data_reg$plot[[1]]
  fig2 <- str_replace(fig, "pdp", "pdprawxgboost")
  fig2a <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
  
  cat("::: {.figure #fig-x}\n")
  cat(paste0("![](", fig2a,"){width=400px}\n\n"))
  cat(paste0("Modelled temporal trend (orange
  ribbon with white line) in ", catg , " with overlayed observed data
  (dots) for the ETP GCRMN region.  The orange bands represent
  80% and 95% (darker) credibility intervals.  Grey ribbon represents 
  years for which there are no observed data.\n"))
  cat(":::\n\n")


  cat('::: {.callout-note collapse="true"}\n#### View weights\n')
  cat("::: {#tbl-wts}\n")
  ## wts |>
  ##   mutate(GCRMN_subregion = str_replace(GCRMN_subregion, "\\.", " ")) |>
  ##   filter(GCRMN_region == reg) |>
  ##   dplyr::select(Region = GCRMN_region,
  ##                 Subregion = GCRMN_subregion,
  ##                 Area = subregion_area) |>
  ##   group_by(Region, Subregion) |>
  ##   summarise(Area = unique(Area), .groups = "drop") |>
  ##   mutate(wt = Area / sum(Area)) |>
    wts_regions |>
      filter(region==reg) |>
      left_join(spatial_lookup |>
        dplyr::select(subregion, subregion_name) |>
        distinct(),
        by="subregion") |>
      dplyr::select(Region=region,
        Subregion=subregion,
        Subregion_name=subregion_name,
        Area=subregion_area,
        Weight = wt
      ) |>
    # knitr::kable(caption = "Subregion reef area and weights applied in the aggregation up to Region") |>
    knitr::kable() |>
    print()
    cat(paste0("Subregion reef area and weights applied in the aggregation up to Region.\n"))
    cat(":::\n")
    cat(":::\n")
     
    cat("::: {.callout-note collapse=true}\n")
    cat("#### Show data behind figure\n")
    cat("::: {#tbl-data}\n")
    summary_region_V2 |>
      filter(category == catg, region == reg) |>
      _[["cellmeans_trim"]][[1]] |>
      dplyr::select(-variable) |>
      dplyr::mutate(across(c(median, lower, upper, lower_80, upper_80), \(x) round(x * 100, 2))) |>
      # knitr::kable(caption = paste0("Estimated annual ", catg, " cover (%) at the region scale.")) |>
      knitr::kable() |>
      print()
    cat(paste0("Estimated annual ", catg, " cover (%) at the region scale.\n")) 
    cat(":::\n")
    cat(":::\n")

    cat("::: {.callout-note collapse=true}\n")
    cat("#### Show contrasts\n")
    cat("::: {#tbl-contr}\n")
    contrasts_regions |>
      filter(category == catg, region == reg) |>
      _[["contrast_sum"]][[1]] |>
      # knitr::kable(caption = paste0("Contrasts between pairs of years for ", catg, " cover (%) at the region scale.
      # For each contrast, results are expressed as absolute change (`abs`) and percentage change (`frac`).  Negative values indicate declines between the pairs of years. `Pl` and `Pg`
      # represent the probability of decline and increase respectively.")) |>
      knitr::kable() |>
      print()
    cat(paste0("- ", 
      contrasts_regions |>
        filter(category == catg, region == reg) |>
        _[["narrative"]][[1]]$interpretation, sep="\n\n")
      )
    cat(paste0("Contrasts between pairs of years for ", catg, " cover (%) at the region scale.
    For each contrast, results are expressed as absolute change (`abs`) and percentage 
    change (`frac`). Estimated start and end values are also presented. Negative values 
    indicate declines between the pairs of years. `Pl` and `Pg` represent the probability 
    of decline and increase respectively.\n"))
    cat(":::\n")
    cat(":::\n")

    cat("::: {#tbl-summ}\n")
    region_tbls |>
      filter(category == catg, region == reg) |>
      _[["tbl"]][[1]] |>
      str_replace_all("\\.\\./\\.\\./", "../") |>
      str_replace_all("lightable-paper", "table") |>
      cat()

    cat(paste0("Change in ", catg, " cover (%) for each Subregion (and
       Regional aggregate at the bottom) depicted as a simplified
       temporal trend as well as the direction of change (arrow)
       between a reference period (< 2010, red line on trends) and the
       2020s (blue line on trends). Values immediately to the left and
       right of the arrows represent the average cover for the
       reference and 2020s respectively.  Values in brackets represent
       the percentage change in percentage cover between the reference
       and 2020s. Weights used to aggregate from Subregion to Region
       are represented by doughnut plots with actual weights displayed
       above doughnuts. Confidence in whether there was a change in
       cover between the reference and 2020s is expressed as a signal
       strength based on Bayesian exceedence probabilities (no bars:
       Pr(Δ>0) < 0.85 (no evidence), one bar: Pr(Δ>0) < 0.90 (weak
       evidence), two bars: Pr(Δ>0) < 0.95 (evidence), three bars:
       Pr(Δ>0) < 1.00 (strong evidence), four bars Pr(Δ>0) = 1.00).
       \n"))
     cat(":::\n\n")
    
}
```

```{r}
#| label: aggregate ecoregion plots MA_Turf
#| eval: true
#| echo: false
#| output: asis
#| warning: false
#| message: false
#| cache: false
reg <- "ETP"
dat_reg <- benthic_posteriors_ecoregions |>
 dplyr::filter(region == reg)
## use Macroalgae as the proxy category
catg <- "Macroalgae"
new_catg <- "Macroalgae and Turf algae"
cat(paste0("## ", new_catg, "\n"))
cat("This section is simply to represent Macroalgae and 
Turf algae in the same figure. Please refer to the individual 
(above) sections on Macroalgae and Turf algae
for more detailed information.
\n\n")
  
dat_cat <- dat_reg |>
  dplyr::filter(category == catg)
## Subregion level =====================================================================
cat(paste0("### Subregion level\n"))
cat("::: {.panel-tabset}\n")
for (subreg in sort(unique(dat_cat$subregion))) {
    dat_subreg <- summary_subregion |>
      dplyr::filter(category == catg, subregion == subreg)
    subreg_name <- dat_subreg |> pull(subregion_name) |> unique()
    cat(paste0("#### ", subreg_name, "\n"))
    fig <- dat_subreg$plot[[1]]
    fig4a_V2 <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
    fig4a_V2 <- str_replace(fig4a_V2, "Macroalgae", "Macroalgae and Turf algae")

    cat("::: {.figure #fig-x}\n")
    cat(paste0("![](", fig4a_V2,"){width=400px}\n\n"))
    cat(paste0("Modelled temporal trend in Macrolgae (green
    ribbon with white line) and Turf algae (blue ribbon with white line) 
    for the ", subreg, " GCRMN subregion.  The green and blue bands represent
    80% and 95% (darker) credibility intervals.  Grey ribbon represents 
    years for which there are no observed data.\n"))
    cat(":::\n\n")
}

cat(":::\n\n")

## Region level =====================================================================
cat(paste0("### Region level\n"))
data_reg <- benthic_posteriors_regions |>
  dplyr::filter(category == catg, region == reg)

fig <- data_reg$plot[[1]]
fig2a <- str_replace(fig, "pdp", "pdp_bayes_a_V2")
fig2a <- str_replace(fig2a, "Macroalgae", "Macroalgae and Turf algae")

cat("::: {.figure #fig-x}\n")
cat(paste0("![](", fig2a,"){width=400px}\n\n"))
cat(paste0("Modelled temporal trend in Macroalgae (green
  ribbon with white line) and Turf algae (blue ribbon with white line)  
  for the ETP GCRMN region.  The green and blue bands represent
  80% and 95% (darker) credibility intervals.  Grey ribbon represents 
  years for which there are no observed data.\n"))
cat(":::\n\n")
```

